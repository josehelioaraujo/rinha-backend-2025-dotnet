# Nginx config otimizado para Rinha Backend 2025
user nginx;
worker_processes auto;
worker_rlimit_nofile 65536;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
    accept_mutex off;
}

http {
    # Performance optimizations
    sendfile on;
    sendfile_max_chunk 512k;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 15;
    keepalive_requests 10000;
    
    # Buffer configurations
    client_body_buffer_size 1k;
    client_max_body_size 1k;
    client_header_buffer_size 1k;
    large_client_header_buffers 2 1k;
    
    # Upstream configuration
    upstream backend {
        least_conn;
        server api1:8080 max_fails=2 fail_timeout=3s;
        server api2:8080 max_fails=2 fail_timeout=3s;
        keepalive 256;
        keepalive_requests 1000;
        keepalive_timeout 60s;
    }
    
    server {
        listen 9999 reuseport;
        server_tokens off;
        
        location / {
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            
            # Aggressive timeouts for sub-millisecond
            proxy_connect_timeout 100ms;
            proxy_send_timeout 500ms;
            proxy_read_timeout 2s;
            
            # Minimal buffering
            proxy_buffering off;
            proxy_request_buffering off;
        }
        
        # Health check optimization
        location = / {
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_connect_timeout 50ms;
            proxy_send_timeout 200ms;
            proxy_read_timeout 500ms;
            proxy_buffering off;
        }
    }
}
